<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="./../tank.png">

    <title>OHMYDOG Speaker</title>

    <link rel="stylesheet" href="./speaker-features/speaker.css">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body>
    <h1></h1>
    <button id="accept" type="button" name="button">Разрешить управление спикером</button>
    <p></p>
    <input id="volume" type="range" min="0" max="100" name="volume" value="35">
    <script type="text/javascript">
        let ws;

        class Filter {
          constructor() {
          }
          static separate (text) {
            const schedule = ['/^', 'пидор', 'пидр', 'пидарас', 'пидорас'];
            // text = text.replace(' ', '');
            schedule.forEach((word) => {
            text = text.replace(new RegExp(`${word}`, 'gi'), 'уууууу');
            });
            return text;
          }
        }
        class Player {
          constructor() {
            this.audio = new Audio();
            this.audio.src = undefined;
            this.audio.controls = false;
            this.audio.autoplay = true;
            document.body.appendChild(this.audio);
            this.context = new AudioContext();
            this.buffer = undefined;
          }
          loadSource(path) {
            console.log(path);
            let request = new XMLHttpRequest();
            request.open("GET", path, true);
            request.responseType= 'arraybuffer';
            request.onload = () => {
              this.context.decodeAudioData(request.response, (buffer) => {
                this.buffer = buffer;
                if (this.buffer) {
                  this.play();
                }
              });
            };
            request.send();
          };
          play() {
            let source = this.context.createBufferSource();
            source.buffer = this.buffer;
            source.connect(this.context.destination);  // added
            source.start(0);
            console.log('playing');
          }
        }
        // init player
        let player = new Player();

        function setConnection() {
          ws = new WebSocket(`ws://${window.location.host.split(':')[0]}:3001`);
            console.log(window.location.host);
          ws.onopen = function() {
            console.log("Соединение установлено.");
            ws.send(JSON.stringify({event: 'speaker-connection'}));
          };

          ws.onclose = function(event) {
            if (event.wasClean) {
              console.log('Соединение закрыто чисто');
            } else {
              console.log('Обрыв соединения');
              setTimeout(()=> {
                setConnection();
              }, 5000)
            }
            console.log('Code: ' + event.code + '\n Reason: ' + event.reason);
          };

          ws.onmessage = (event) => {
            let depeche = JSON.parse(event.data);
            console.log(depeche);
            switch (depeche.event) {
              case 'hl_msg':
              console.log(depeche.message);
                speak(Filter.separate(depeche.message));
              break;
              case 'sound_msg':
                player.loadSource(depeche.message);
              break;
              case 'connection':
                console.log(depeche.message);
              break;
              default:
            }
          }

          ws.onerror = function(error) {
            console.log("Ошибка " + error.message);
          };
        }

        var synth = window.speechSynthesis;

        var pitchValue = 1;
        var rateValue = 1;
        let volume = window.localStorage.getItem('volume');
        let volumeRanger = document.querySelector('#volume');
            volumeRanger.value = volume*100;

        let msg = document.querySelector('p');

        var voices = [];

        var btn = document.querySelector('#accept');
            btn.addEventListener('click', ()=> {
              // speak('');
              msg.innerHTML = 'Разрешено управление спикером';
              btn.style.display = 'none';
              volumeRanger.style.display = 'block';
            })
            volumeRanger.addEventListener('change', () => {
              volume = volumeRanger.value/100;
              window.localStorage.setItem('volume', volume);
            })
        function setSpeech() {
            return new Promise(
                function (resolve, reject) {
                    let synth = window.speechSynthesis;
                    let id;

                    id = setInterval(() => {
                        if (synth.getVoices().length !== 0) {
                            resolve(synth.getVoices());
                            clearInterval(id);
                        }
                    }, 10);
                }
            )
        }

        let s = setSpeech();
        async function populateVoiceList() {
          voices = await s.then((voices) => voices);
          voices = voices.sort(function (a, b) {
            const aname = a.name.toUpperCase(), bname = b.name.toUpperCase();
            if ( aname < bname ) return -1;
            else if ( aname == bname ) return 0;
            else return +1;
          });
        }
        function speak (text){
          if (synth.speaking) {
              console.error('speechSynthesis.speaking');
              msg.innerHTML = 'Ошибка';
              return;
          }
          if (text !== '') {
            let selectedOption;
            console.log(voices);
            if (text.includes(']p[')) {
              let params = text.split(']p[');
                  text = params[0];
                  selectedOption = voices[params[1].split('|')[0]].name;
                  pitchValue = +params[1].split('|')[1];
            } else {
                selectedOption = 'Google русский';
            }
            msg.innerHTML = text;
            let utterThis = new SpeechSynthesisUtterance(text);
            for(i = 0; i < voices.length ; i++) {
              if(voices[i].name === selectedOption) {
                utterThis.voice = voices[i];
                break;
              }
            }
            utterThis.pitch = pitchValue;
            utterThis.rate = rateValue;
            utterThis.volume = volume;
            utterThis.pitch =
            synth.speak(utterThis);
          }
        }
        populateVoiceList();
        setConnection();
    </script>
  </body>
</html>
